import{j as e}from"./query-_HUGc1jU.js";import{r as o,u as re}from"./router-CGnu6c2M.js";import{d as R,a as H}from"./index-C7a0D0cT.js";import{h as oe,j as ie,k as ce,l as K,m as de,o as me}from"./firebase-CGo28arV.js";import{F as r,s as ue,u as _,c as w,v as xe,w as V,x as J,o as Q,y as ge,z as he,d as fe,j as pe,A as be,r as Ne}from"./ui-ZG8wUPwK.js";import"./vendor-Dazix4UH.js";const W="studentsCache_v2",X="studentsCacheTimestamp",je=300*1e3,Ie=()=>{const[m,D]=o.useState([]),[N,Z]=o.useState(""),[I,ee]=o.useState("name"),[U,f]=o.useState(!1),[L,A]=o.useState(null),[$,j]=o.useState(!1),[B,se]=o.useState(0),[g,Y]=o.useState(null),[i,te]=o.useState([]),[y,ae]=o.useState(!1),v=re();o.useRef(Date.now());const S=o.useRef(!1),q=o.useCallback(()=>{try{const s=localStorage.getItem(W),n=localStorage.getItem(X);if(s&&n&&Date.now()-parseInt(n)<je){const u=JSON.parse(s);if(Array.isArray(u)&&u.length>0)return u}}catch(s){console.log("Cache read failed:",s)}return null},[]),p=o.useCallback(async s=>{if(!s||S.current){console.log("âŒ Data already fetched, skipping");return}console.log("ðŸš€ Starting simple data fetch for user:",s.uid);const n=Date.now();f(!0),A(null),S.current=!0;try{console.log("ðŸ” Step 1: Getting faculty data...");let a=null;const u=oe(R,"faculty","CSE_DS","members",s.uid),O=await ie(u);O.exists()?(a=O.data(),Y(a),console.log("âœ… Faculty found:",a.name,"authUid:",a.authUid)):(console.log("âŒ Faculty not found, using user.uid as instructor"),a={authUid:s.uid,name:s.email,department:"Unknown"},Y(a));const z=a.authUid;console.log("ðŸŽ¯ Looking for courses where instructor =",z),console.log("ðŸ” Step 2: Finding instructor courses...");const C=[],le=ce(R,"courseDetails"),G=await K(le);console.log(`ðŸ“š Found ${G.docs.length} total courses`);for(const t of G.docs){const l=t.data(),d=t.id;console.log(`ðŸ” Course: ${l.courseName}, Instructor: ${l.instructor}`),l.instructor===z&&(console.log(`âœ… Match found! Course: ${l.courseName}`),C.push({id:d,courseName:l.courseName,courseCode:l.courseCode,instructor:l.instructor,studentsBySection:l.studentsBySection,students:l.students||[],year:l.displayYear?.split("_")[0]||"III",section:l.displaySection||"All",semester:l.displaySemester||"5",credits:l.credits||3}))}te(C),console.log(`ðŸ‘¨â€ðŸ« Found ${C.length} instructor courses`),console.log("ðŸ” Step 3: Getting students from instructor courses...");const F=new Set,c=new Map;C.forEach(t=>{console.log(`ðŸ“š Processing course: ${t.courseName}`),t.studentsBySection&&typeof t.studentsBySection=="object"&&Object.entries(t.studentsBySection).forEach(([l,d])=>{Array.isArray(d)&&(console.log(`   Section ${l}: ${d.length} students`),d.forEach(x=>{F.add(x),c.has(x)||c.set(x,[]),c.get(x).push({courseName:t.courseName,courseCode:t.courseCode,section:l,semester:t.semester,year:t.year})}))}),t.students&&Array.isArray(t.students)&&(console.log(`   Direct students: ${t.students.length} students`),t.students.forEach(l=>{F.add(l),c.has(l)||c.set(l,[]),c.get(l).push({courseName:t.courseName,courseCode:t.courseCode,section:t.section,semester:t.semester,year:t.year})}))});const b=Array.from(F);console.log(`ðŸ“š Found ${b.length} unique students from instructor courses`),console.log("ðŸ” uniqueStudentIds type:",typeof b),console.log("ðŸ” uniqueStudentIds is Array:",Array.isArray(b)),console.log("ðŸ” Sample student IDs:",b.slice(0,5));const h=new Set(b);console.log("ðŸ” uniqueStudentIdsSet is Set:",h instanceof Set),console.log("ðŸ” uniqueStudentIdsSet size:",h.size),console.log("ðŸ” Step 4: Fetching student details...");const k=[],ne=[["students","CSEDS","III-A"],["students","CSEDS","III-B"],["students","CSEDS","III-C"],["students","CSE_DS","III_A"],["students","CSE_DS","III_B"],["students","CSE_DS","III_C"]];for(const t of ne)try{const l=de(R,...t),d=await K(l);console.log(`ðŸ“š Found ${d.docs.length} students in ${t.join("/")}`),k.push(...d.docs.map(x=>({id:x.id,...x.data()})))}catch{console.log(`âŒ Failed to fetch from ${t.join("/")}`)}const T=k.filter(t=>!h||!(h instanceof Set)?(console.log("âŒ uniqueStudentIdsSet is not a valid Set:",h),!1):!t||!t.id?(console.log("âŒ Student or student.id is missing:",t),!1):h.has(t.id)).map(t=>({...t,enrolledCourses:c.get(t.id)||[],totalCourses:(c.get(t.id)||[]).length}));if(console.log(`âœ… Found ${T.length} instructor students`),T.length===0){console.log("âš ï¸ No instructor students found, showing all students");const t=k.map(l=>({...l,enrolledCourses:[],totalCourses:0}));D(t)}else D(T);const P=Date.now()-n;se(P),console.log(`ðŸš€ Data loaded in ${P}ms`)}catch(a){console.error("Data fetch failed:",a),A("Failed to load data. Please try again."),S.current=!1}finally{f(!1)}},[]);o.useEffect(()=>{const s=q();s?(D(s),f(!1),j(!0)):f(!0)},[q]),o.useEffect(()=>{let s;return(async()=>{s=me(H,async a=>{if(!a){A("No user is logged in."),f(!1),j(!1);return}m.length>0?p(a):await p(a)})})(),()=>{s&&s()}},[p,m.length]);const E=o.useMemo(()=>{let s=m;if(N){const n=N.toLowerCase();s=s.filter(a=>(a.name||"").toLowerCase().includes(n)||(a.email||"").toLowerCase().includes(n)||(a.rollNo||"").toLowerCase().includes(n))}return s.sort((n,a)=>I==="name"?(n.name||"").localeCompare(a.name||""):0)},[m,N,I]),M=o.useCallback(async()=>{console.log("ðŸ”„ Manual refresh triggered"),j(!0),S.current=!1;try{localStorage.removeItem(W),localStorage.removeItem(X),console.log("ðŸ—‘ï¸ Cache cleared")}catch(n){console.log("Cache clear failed:",n)}const s=H.currentUser;s?(console.log("ðŸ”„ Starting fresh data fetch for user:",s.uid),await p(s)):(console.log("âŒ No user found for refresh"),j(!1))},[p]);return U&&m.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-12 animate-fade-in",children:[e.jsx("div",{className:"h-16 bg-gray-200 rounded-2xl mb-6 animate-pulse"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded-xl w-1/3 animate-pulse"})]}),e.jsx("div",{className:"grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:Array.from({length:9}).map((s,n)=>e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 animate-fade-in border border-gray-100",style:{animationDelay:`${n*50}ms`},children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-200 rounded-full mr-6 animate-pulse"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-3/4 mb-3 animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2 animate-pulse"})]})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3 animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2 animate-pulse"})]}),e.jsxs("div",{className:"flex gap-3 mb-6",children:[e.jsx("div",{className:"h-8 w-20 bg-gray-200 rounded-full animate-pulse"}),e.jsx("div",{className:"h-8 w-24 bg-gray-200 rounded-full animate-pulse"})]}),e.jsx("div",{className:"h-6 w-24 bg-gray-200 rounded animate-pulse"})]},n))})]})}):L&&m.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center p-8",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100",children:[e.jsx(r,{icon:ue,className:"text-blue-600 text-6xl mb-6 animate-bounce"}),e.jsx("div",{className:"text-gray-800 text-xl font-semibold mb-6",children:L}),e.jsxs("button",{onClick:M,className:"btn-campus-primary inline-flex items-center gap-3 px-8 py-4 rounded-xl shadow-lg transition-all duration-300 text-lg font-medium",children:[e.jsx(r,{icon:_}),"Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"page-container",children:[g&&e.jsx("div",{className:"compact-card mb-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center",children:e.jsx(r,{icon:w,className:"text-blue-600 text-xl"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:g.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[g.designation," â€¢ ",g.department]}),i.length>0?e.jsxs("p",{className:"text-xs text-gray-500",children:["Teaching ",i.length," course",i.length!==1?"s":""]}):e.jsx("p",{className:"text-xs text-orange-600",children:"No instructor courses found for this semester"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:i.length}),e.jsx("div",{className:"text-xs text-gray-500",children:"Active Courses"})]})]})}),i.length>0?e.jsxs("div",{className:"compact-card mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(r,{icon:w,className:"text-blue-600 text-xl"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Your Teaching Courses"}),e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full",children:[i.length," course",i.length!==1?"s":""]})]}),e.jsxs("button",{onClick:()=>ae(!y),className:"text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center gap-2",children:[y?"Hide Details":"Show Details",e.jsx(r,{icon:y?xe:V,className:"text-xs"})]})]}),y&&e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:i.map((s,n)=>e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4 hover:shadow-md transition-all duration-200",style:{animationDelay:`${n*100}ms`},children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-sm mb-1",children:s.courseName}),e.jsx("p",{className:"text-xs text-gray-600 mb-2",children:s.courseCode}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:J,className:"text-blue-600"}),e.jsxs("span",{children:[s.year," Year - ",s.section," Section"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full",children:[s.credits||3," Credits"]})})]}),e.jsxs("div",{className:"space-y-2 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:Q,className:"text-blue-600"}),e.jsxs("span",{children:[s.students&&Array.isArray(s.students)?s.students.length:s.studentsBySection&&typeof s.studentsBySection=="object"?Object.values(s.studentsBySection).flat().length:0," students"]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:ge,className:"text-blue-600"}),e.jsx("span",{children:s.displayDepartment||"Computer Science & Engineering (Data Science)"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>v(`/courses/${s.year}/${s.section}/${s.semester}/${s.courseId}`),className:"flex-1 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium px-3 py-2 rounded-md transition-colors duration-200",children:"View Course"}),e.jsx("button",{onClick:()=>v(`/attendance/${s.courseId}`),className:"bg-green-600 hover:bg-green-700 text-white text-xs font-medium px-3 py-2 rounded-md transition-colors duration-200",children:"Attendance"})]})]},s.id))})]}):e.jsx("div",{className:"compact-card mb-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx(r,{icon:w,className:"text-gray-400 text-4xl mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-700 mb-2",children:"No Instructor Courses Found"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"You are not currently assigned as an instructor for any courses this semester."}),e.jsxs("div",{className:"bg-blue-50 rounded-lg p-4 text-sm text-blue-800",children:[e.jsx("p",{className:"mb-2",children:e.jsx("strong",{children:"Debug Information:"})}),e.jsxs("p",{children:["â€¢ Faculty AuthUid: ",g?.authUid||"Not found"]}),e.jsxs("p",{children:["â€¢ Department: ",g?.department||"Not found"]}),e.jsxs("p",{children:["â€¢ Instructor Courses Found: ",i.length]}),e.jsxs("p",{children:["â€¢ Found ",m.length," total students in fallback"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:i.length>0?"Your Students":"All Students"}),e.jsx("span",{className:"text-xs text-gray-500",children:B>0?`Loaded in ${B}ms`:"Loading..."}),$&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(r,{icon:_,className:"animate-spin"}),"Refreshing"]}),i.length===0&&e.jsx("span",{className:"bg-orange-100 text-orange-800 text-xs font-medium px-2 py-1 rounded-full",children:"Fallback Data"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-semibold text-gray-900",children:E.length}),e.jsx("div",{className:"text-xs text-gray-500",children:i.length>0?"Students in Your Courses":"Total Students"})]}),e.jsxs("button",{onClick:M,disabled:$,className:"btn-campus-primary inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm disabled:opacity-50",children:[e.jsx(r,{icon:_,className:$?"animate-spin":""}),"Refresh"]})]})]}),e.jsx("div",{className:"compact-card mb-6",children:e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsx("div",{children:e.jsxs("div",{className:"relative",children:[e.jsx(r,{icon:he,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"}),e.jsx("input",{type:"text",placeholder:"Search students by name, email, or roll number...",value:N,onChange:s=>Z(s.target.value),className:"w-full pl-10 pr-3 py-2 rounded-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-gray-50"})]})}),e.jsx("div",{children:e.jsxs("select",{value:I,onChange:s=>ee(s.target.value),className:"w-full px-3 py-2 rounded-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-gray-50",children:[e.jsx("option",{value:"name",children:"Sort by Name"}),e.jsx("option",{value:"rollNo",children:"Sort by Roll No"})]})})]})}),e.jsx("section",{className:"grid gap-4 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:E.map((s,n)=>e.jsxs("div",{className:"group bg-white rounded-lg border p-4 hover:shadow-md animate-fade-in cursor-pointer transition-all",style:{animationDelay:`${n*50}ms`},onClick:()=>v(`/students/${s.year||"II"}/${s.section||"A"}/${s.id}`),children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mr-3",children:e.jsx(r,{icon:fe,className:"text-sm"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 truncate",children:s.name||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-600",children:s.rollNo||"N/A"})]}),e.jsxs("div",{className:"flex flex-col items-end",children:[e.jsx("div",{className:"w-2.5 h-2.5 bg-green-500 rounded-full mb-1"}),e.jsxs("span",{className:"bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded-full",children:[s.totalCourses||0," course",s.totalCourses!==1?"s":""]})]})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:pe,className:"text-blue-600 text-sm"}),e.jsx("span",{className:"truncate",children:s.email||"No email"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:be,className:"text-blue-600 text-sm"}),e.jsx("span",{children:s.rollNo||"No Roll No"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(r,{icon:J,className:"text-blue-600 text-sm"}),e.jsxs("span",{children:[s.year||"N/A","-",s.section||"N/A"]})]})]}),s.enrolledCourses&&s.enrolledCourses.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(r,{icon:w,className:"text-blue-600 text-xs"}),e.jsx("span",{className:"text-xs font-medium text-gray-700",children:"Enrolled in Your Courses:"})]}),e.jsxs("div",{className:"space-y-1",children:[s.enrolledCourses.slice(0,2).map((a,u)=>e.jsxs("div",{className:"bg-blue-50 rounded px-2 py-1",children:[e.jsx("div",{className:"text-xs font-medium text-blue-800",children:a.courseName}),e.jsxs("div",{className:"text-xs text-blue-600",children:[a.courseCode," â€¢ ",a.section," â€¢ ",a.semester," sem"]})]},u)),s.enrolledCourses.length>2&&e.jsxs("div",{className:"text-xs text-gray-500 text-center",children:["+",s.enrolledCourses.length-2," more course",s.enrolledCourses.length-2!==1?"s":""]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("span",{className:"status-active inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",children:[e.jsx(r,{icon:Ne,className:"mr-1"}),"Active"]}),e.jsxs("span",{className:"status-completed inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",children:[s.year||"N/A","-",s.section||"N/A"]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:a=>{a.stopPropagation(),v(`/students/${s.year||"II"}/${s.section||"A"}/${s.id}`)},className:"inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-700 font-medium transition-all text-sm",children:["View Details",e.jsx(r,{icon:V,className:"transition-transform group-hover:translate-x-1"})]})})]},s.id))}),E.length===0&&!U&&e.jsx("div",{className:"text-center py-16",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-12 border border-gray-100",children:[e.jsx(r,{icon:Q,className:"text-gray-400 text-6xl mb-6"}),e.jsx("h3",{className:"text-2xl font-semibold text-gray-700 mb-3",children:"No students found"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"Try adjusting your search or filter criteria."})]})})]})})};export{Ie as default};
//# sourceMappingURL=StudentList-BqnGFOXH.js.map
