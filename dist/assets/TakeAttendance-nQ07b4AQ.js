import{j as e}from"./query-_HUGc1jU.js";import{u as te,h as re,g as ae,r as c}from"./router-CGnu6c2M.js";import{d as u,a as B}from"./index-DAak1JJl.js";import{t as se,m as G,o as ne,k as z,l as D,q as P,w as q,v as de,h as E,j as R}from"./firebase-CGo28arV.js";import{F as g,g as oe,h as le,t as V,e as _,s as H,q as J,a2 as K}from"./ui-BE1NG-gw.js";import"./vendor-Dazix4UH.js";const pe=()=>{const F=te(),{state:Q}=re(),{year:ie,section:ce,semester:ge,courseId:k}=ae(),[a,L]=c.useState(Q?.course||null),[$,W]=c.useState([]),[m,A]=c.useState({}),[O,U]=c.useState(!1),[M,xe]=c.useState(()=>new Date),[X,h]=c.useState(!0),[T,j]=c.useState(null),[y,Y]=c.useState([]),[I,Z]=c.useState({});c.useEffect(()=>{let t;return(async()=>{h(!0),j(null);try{await new Promise(r=>{t=ne(B,async n=>{if(!n){j("Not authenticated"),h(!1),r();return}try{if(!a&&k){const d=z(u,"courseDetails");(await D(P(d,q(de(),"in",[k])))).forEach(o=>{const i=o.ref.path.split("/");L({id:o.id,year:i[1],section:i[2],semester:i[3],...o.data()})})}if(!a&&!k){let d=[];try{const l=z(u,"courseDetails");d=(await D(P(l,q("instructor","==",n.uid)))).docs.map(i=>{const x=i.ref.path.split("/");return{id:i.id,year:x[1],section:x[2],semester:x[3],...i.data()}})}catch{const o=["I","II","III","IV"],i=["A","B","C","D","E","F"],x=["sem1","sem2"],b=[];o.forEach(p=>{i.forEach(v=>{x.forEach(w=>{b.push(D(P(G(u,"courses",p,v,w,"courseDetails"),q("instructor","==",n.uid))))})})}),(await Promise.all(b)).forEach(p=>{p.forEach(v=>{const w=v.ref.path.split("/");d.push({id:v.id,year:w[1],section:w[2],semester:w[3],...v.data()})})})}Y(d)}}catch{}h(!1),r()})})}catch{j("Failed to initialize"),h(!1)}})(),()=>t&&t()},[a,k]),c.useEffect(()=>{(async()=>{if(!y||y.length===0)return;const s={};for(const r of y){const n=Array.isArray(r.students)?r.students:[],d=[];let l=n.length;for(let o=0;o<Math.min(n.length,5);o++){const i=n[o],x=[E(u,`students/${r.year}/${r.section}/${i}`),E(u,`students/${i}`)];let b=null;for(const N of x){const p=await R(N);if(p.exists()){b=p;break}}if(b&&b.exists()){const N=b.data();d.push({name:N.name||i,rollNo:N.rollNo||""})}}s[r.id]={count:l,items:d}}Z(s)})()},[y]),c.useEffect(()=>{(async()=>{if(a){h(!0);try{let s=Array.isArray(a.students)?a.students:[];s.length===0&&(s=[]);const r=[];if(s.length>0)for(const d of s){const l=[E(u,`students/${a.year}/${a.section}/${d}`),E(u,`students/${d}`)];let o=null;for(const i of l){const x=await R(i);if(x.exists()){o=x;break}}o&&o.exists()&&r.push({id:o.id,...o.data(),year:a.year,section:a.section})}W(r);const n={};r.forEach(d=>{n[d.id]={present:!1,late:!1,excused:!1,absent:!0,note:""}}),A(n)}catch{j("Failed to load students")}finally{h(!1)}}})()},[a]);const C=(t,s)=>{A(r=>({...r,[t]:{...r[t],present:s==="present",late:s==="late",excused:s==="excused",absent:s==="absent"}}))},S=t=>{A(s=>{const r={...s};return Object.keys(r).forEach(n=>{r[n]={...r[n],present:t==="present",late:t==="late",excused:t==="excused",absent:t==="absent"}}),r})},f=c.useMemo(()=>{const t=Object.values(m),s=t.filter(l=>l.present).length,r=t.filter(l=>l.late).length,n=t.filter(l=>l.excused).length,d=t.filter(l=>l.absent).length;return{total:$.length,present:s,late:r,excused:n,absent:d}},[m,$.length]),ee=c.useCallback(async()=>{if(a){U(!0);try{await se(G(u,"attendance"),{courseId:a.id,courseName:a.courseName||a.id,date:M.toISOString(),facultyId:B.currentUser?.uid||"",attendance:m,totalStudents:f.total,presentCount:f.present,lateCount:f.late,excusedCount:f.excused,absentCount:f.absent,createdAt:new Date().toISOString()}),F(-1)}catch{j("Failed to save attendance")}finally{U(!1)}}},[a,M,m,f,F]);return X?e.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 p-8",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"mb-12 animate-fade-in",children:[e.jsx("div",{className:"h-16 bg-gray-200 dark:bg-gray-700 rounded-2xl mb-6 animate-pulse"}),e.jsx("div",{className:"h-8 bg-gray-200 dark:bg-gray-700 rounded-xl w-1/3 animate-pulse"})]})})}):T?e.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 flex items-center justify-center p-8",children:e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-12 text-center border border-gray-200 dark:border-gray-700",children:e.jsx("div",{className:"text-gray-950 dark:text-white text-xl font-semibold",children:T})})}):e.jsx("div",{className:"min-h-screen bg-gray-100 dark:bg-gray-900 p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx("div",{className:"bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6 shadow-lg mb-8",children:e.jsx("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between",children:e.jsxs("div",{className:"mb-4 lg:mb-0",children:[e.jsxs("h1",{className:"text-3xl lg:text-4xl font-bold text-gray-950 dark:text-white flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-xl flex items-center justify-center shadow-lg",children:e.jsx(g,{icon:oe,className:"text-white text-lg"})}),"Take Attendance"]}),e.jsxs("p",{className:"text-gray-800 dark:text-gray-200 text-base flex items-center gap-2",children:[e.jsx(g,{icon:le,className:"text-gray-800 dark:text-gray-200"}),a?`${a?.courseName||k} • ${a?.year}-${a?.section} • ${a?.semester?.toUpperCase?.()||a?.semester}`:"Select a course to begin"]})]})})}),!a&&(y.length===0?e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-12 text-center border border-gray-200 dark:border-gray-700",children:[e.jsx(g,{icon:V,className:"text-blue-600 dark:text-blue-400 text-4xl mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-950 dark:text-white mb-2",children:"No courses found"}),e.jsx("p",{className:"text-gray-800 dark:text-gray-200",children:"No courses found for your account."})]}):e.jsx("section",{className:"grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:y.map((t,s)=>e.jsxs("div",{className:"group bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6 shadow-lg hover:shadow-xl transition-all duration-300 animate-fade-in hover:-translate-y-1",style:{animationDelay:`${s*100}ms`},children:[e.jsx("div",{className:"flex items-start justify-between mb-4",children:e.jsx("div",{className:"w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300",children:e.jsx(g,{icon:V,className:"text-lg"})})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-950 dark:text-white mb-3 group-hover:text-secondary transition-colors",children:t.courseName||t.id}),e.jsxs("p",{className:"text-gray-800 dark:text-gray-200 mb-4 text-sm leading-relaxed",children:[t.year,"-",t.section," • ",t.semester?.toUpperCase?.()||t.semester]})]}),e.jsxs("div",{className:"space-y-3 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-800 dark:text-gray-200",children:[e.jsx(g,{icon:_,className:"text-primary"}),e.jsxs("span",{children:["Enrolled Students: ",I[t.id]?.count??0]})]}),I[t.id]?.items?.length>0&&e.jsx("div",{className:"space-y-1",children:I[t.id].items.map((r,n)=>e.jsxs("div",{className:"text-xs text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 rounded-lg px-3 py-2",children:["• ",r.name,r.rollNo?` (${r.rollNo})`:""]},n))})]}),e.jsx("button",{onClick:()=>L(t),className:"bg-primary hover:bg-secondary text-white font-semibold px-4 py-2 rounded-xl text-sm transition-all duration-300 hover:shadow-md",children:"Start"})]},t.id))})),a&&e.jsxs("section",{className:"bg-white dark:bg-gray-800 rounded-2xl border border-gray-200 dark:border-gray-700 p-6 shadow-lg",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:[e.jsx("span",{className:"text-sm text-gray-800 dark:text-gray-200",children:"Mark all as:"}),e.jsxs("button",{onClick:()=>S("present"),className:"px-4 py-2 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 text-sm font-medium hover:bg-green-200 dark:hover:bg-green-900/50 border border-green-200 dark:border-green-700 transition-all duration-300",children:[e.jsx(g,{icon:H,className:"mr-2"}),"Present"]}),e.jsxs("button",{onClick:()=>S("late"),className:"px-4 py-2 rounded-xl bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 text-sm font-medium hover:bg-orange-200 dark:hover:bg-orange-900/50 border border-orange-200 dark:border-orange-700 transition-all duration-300",children:[e.jsx(g,{icon:J,className:"mr-2"}),"Late"]}),e.jsx("button",{onClick:()=>S("excused"),className:"px-4 py-2 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 text-sm font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 border border-blue-200 dark:border-blue-700 transition-all duration-300",children:"Excused"}),e.jsxs("button",{onClick:()=>S("absent"),className:"px-4 py-2 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 text-sm font-medium hover:bg-red-200 dark:hover:bg-red-900/50 border border-red-200 dark:border-red-700 transition-all duration-300",children:[e.jsx(g,{icon:K,className:"mr-2"}),"Absent"]})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:$.map(t=>e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl p-4 hover:bg-gray-100 dark:hover:bg-gray-600 transition-all duration-300",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center",children:e.jsx(g,{icon:_,className:"text-white text-sm"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-bold text-gray-950 dark:text-white",children:t.name||t.id}),e.jsx("div",{className:"text-xs text-gray-800 dark:text-gray-200",children:t.rollNo||t.email})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>C(t.id,"present"),className:`px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ${m[t.id]?.present?"bg-green-600 text-white shadow-lg":"bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-green-100 dark:hover:bg-green-900/30 border border-gray-200 dark:border-gray-600"}`,children:[e.jsx(g,{icon:H,className:"mr-2"}),"Present"]}),e.jsxs("button",{onClick:()=>C(t.id,"late"),className:`px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ${m[t.id]?.late?"bg-orange-600 text-white shadow-lg":"bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-orange-100 dark:hover:bg-orange-900/30 border border-gray-200 dark:border-gray-600"}`,children:[e.jsx(g,{icon:J,className:"mr-2"}),"Late"]}),e.jsx("button",{onClick:()=>C(t.id,"excused"),className:`px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ${m[t.id]?.excused?"bg-blue-600 text-white shadow-lg":"bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-blue-100 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600"}`,children:"Excused"}),e.jsxs("button",{onClick:()=>C(t.id,"absent"),className:`px-4 py-2 rounded-xl text-sm font-medium transition-all duration-300 ${m[t.id]?.absent?"bg-red-600 text-white shadow-lg":"bg-gray-100 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-red-100 dark:hover:bg-red-900/30 border border-gray-200 dark:border-gray-600"}`,children:[e.jsx(g,{icon:K,className:"mr-2"}),"Absent"]})]})]})},t.id))}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:ee,disabled:O,className:"bg-primary hover:bg-secondary text-white font-semibold px-6 py-3 rounded-xl text-sm transition-all duration-300 hover:shadow-md disabled:opacity-50",children:O?"Saving...":"Save Attendance"})})]})]})})};export{pe as default};
//# sourceMappingURL=TakeAttendance-nQ07b4AQ.js.map
