import{j as e}from"./query-_HUGc1jU.js";import{r as d,u as le}from"./router-CGnu6c2M.js";import{d as w,a as Z}from"./index-DokKvUxf.js";import{h as B,j as P,k as ce,q as de,w as me,l as ue,m as xe,o as fe}from"./firebase-BUGgE2xq.js";import{F as m,s as he,u as T,v as ge,d as ye,j as pe,w as Se,x as be,r as Ne,y as je,o as Ce}from"./ui-CbbphKl4.js";import"./vendor-Dazix4UH.js";const F="studentsCache_v2",R="studentsCacheTimestamp",ve=300*1e3,ke=()=>{const[g,K]=d.useState([]),[p,ee]=d.useState(""),[E,se]=d.useState("name"),[L,S]=d.useState(!1),[M,O]=d.useState(null),[te,ae]=d.useState([]),[b,re]=d.useState(""),[I,De]=d.useState(""),[A,ne]=d.useState({}),[_,N]=d.useState(!1),[U,ie]=d.useState(0),G=le();d.useRef(Date.now());const $=d.useRef(!1),q=d.useCallback(()=>{try{const s=localStorage.getItem(F),c=localStorage.getItem(R);if(s&&c&&Date.now()-parseInt(c)<ve){const u=JSON.parse(s);if(Array.isArray(u)&&u.length>0)return u}}catch(s){console.log("Cache read failed:",s)}return null},[]),y=d.useCallback(async s=>{if(!s||$.current)return;$.current=!0;const c=Date.now();try{console.log("🚀 Dynamic course fetch starting for user:",s.uid);let r=null;try{const t=[["faculty",r?.departmentKey||"CSE_DS","members",s.uid],["faculty","CSE_DS","members",s.uid],["faculty","CSEDS","members",s.uid],["faculty","CSE","members",s.uid],["faculty",s.uid],["users","faculty",s.uid]];for(const i of t)try{const o=B(w,...i),a=await P(o);if(a.exists()){r=a.data(),console.log("✅ Faculty data fetched:",r.name);break}}catch{}}catch(t){console.log("❌ Could not fetch faculty data:",t)}const u=[];r?.courses&&Array.isArray(r.courses)&&u.push(...r.courses),r?.teaching&&Object.keys(r.teaching).forEach(t=>{Array.isArray(r.teaching[t])&&u.push(...r.teaching[t])});const j=[...new Set(u)];console.log("📚 Course IDs from faculty data:",j);let C=[];if(j.length>0){console.log("🚀 Dynamic course fetch using course IDs:",j);const t=async a=>{try{const f=ce(w,"courseDetails"),l=de(f,me(ue(),"==",a)),h=await xe(l);if(!h.empty){const n=h.docs[0].data();return console.log("✅ Found course via collectionGroup:",n.courseName),{id:a,year:n.displayYear||"III",section:n.displaySection||"A",semester:n.displaySemester||"5",courseName:n.courseName||`Course ${a}`,courseCode:n.courseCode||a,instructorName:r?.name,instructor:n.instructor,department:n.displayDepartment||"Computer Science & Engineering (Data Science)",credits:n.credits||3,description:n.description||`Course ${a} - ${r?.name}`,studentsBySection:n.studentsBySection||{},masterCoursePath:n.masterCoursePath,semesterKey:n.semesterKey||"III_5",students:n.students||[]}}}catch{console.log("❌ CollectionGroup failed for course:",a)}const D=[["courses",r?.departmentKey||"CSE_DS","year_sem","III_5","courseDetails",a],["courses",r?.departmentKey||"CSE_DS","year_sem","III_6","courseDetails",a],["courses",r?.departmentKey||"CSE_DS","year_sem","III_7","courseDetails",a],["courses",r?.departmentKey||"CSE_DS","year_sem","III_8","courseDetails",a],["courses","CSE_DS","year_sem","III_5","courseDetails",a],["courses","CSEDS","year_sem","III_5","courseDetails",a],["courses","CSE","year_sem","III_5","courseDetails",a],["courses",a],["courseDetails",a]];for(const f of D)try{const l=B(w,...f),h=await P(l);if(h.exists()){const n=h.data();return console.log("✅ Found course via path variation:",f.join("/")),{id:a,year:n.displayYear||"III",section:n.displaySection||"A",semester:n.displaySemester||"5",courseName:n.courseName||`Course ${a}`,courseCode:n.courseCode||a,instructorName:r?.name,instructor:n.instructor,department:n.displayDepartment||"Computer Science & Engineering (Data Science)",credits:n.credits||3,description:n.description||`Course ${a} - ${r?.name}`,studentsBySection:n.studentsBySection||{},masterCoursePath:n.masterCoursePath,semesterKey:n.semesterKey||"III_5",students:n.students||[]}}}catch{}return console.log("❌ No course found for ID:",a),null},i=j.map(a=>t(a));C=(await Promise.all(i)).filter(a=>a!==null),console.log("✅ Dynamic fetch found:",C.length,"courses")}const x=new Map,Y=[];C.forEach(t=>{Y.push({id:t.id,name:t.courseName,year:t.year,section:t.section,semester:t.semester}),t.studentsBySection&&typeof t.studentsBySection=="object"?(console.log("📚 Found studentsBySection structure for course:",t.courseName),Object.keys(t.studentsBySection).forEach(i=>{Array.isArray(t.studentsBySection[i])&&t.studentsBySection[i].forEach(o=>{const a=`${t.year}|${i}`;x.has(a)||x.set(a,new Set),x.get(a).add(o)})})):t.students&&Array.isArray(t.students)&&(console.log("📚 Found students array structure for course:",t.courseName),t.students.forEach(i=>{const o=typeof i=="string"?i:i?.id||i?.studentId||i;if(o){const a=`${t.year}|${t.section}`;x.has(a)||x.set(a,new Set),x.get(a).add(o)}}))}),ae(Y);const H=[],v={};C.forEach(t=>{v[t.id]=[],t.studentsBySection&&typeof t.studentsBySection=="object"?Object.keys(t.studentsBySection).forEach(i=>{Array.isArray(t.studentsBySection[i])&&t.studentsBySection[i].forEach(o=>{v[t.id].push(o)})}):t.students&&Array.isArray(t.students)&&t.students.forEach(i=>{const o=typeof i=="string"?i:i?.id||i?.studentId||i;o&&v[t.id].push(o)})}),ne(v);for(const[t,i]of x.entries()){const[o,a]=t.split("|"),D=Array.from(i);console.log(`📚 Fetching ${D.length} students for ${o}-${a}`);const f=D.map(async l=>{const h=[["students",r?.departmentKey||"CSEDS",`${o}-${a}`,l],["students",r?.departmentKey||"CSE_DS",`${o}_${a}`,l],["students","CSEDS",`${o}-${a}`,l],["students","CSE_DS",`${o}_${a}`,l],["students","CSE",`${o}-${a}`,l],["students","CSEDS","III-A",l],["students","CSE_DS","III_A",l],["students","CSE","III-A",l],["students","CSEDS","III-B",l],["students","CSE_DS","III_B",l],["students","CSEDS","III-C",l],["students","CSE_DS","III_C",l],["students",l],["studentDetails",l]];for(const n of h)try{const W=B(w,...n),X=await P(W);if(X.exists())return{id:l,year:o,section:a,...X.data()}}catch{}return{id:l,name:`Student ${l}`,rollNo:l,year:o,section:a}});H.push(Promise.all(f))}const oe=await Promise.all(H),z=[];oe.forEach(t=>z.push(...t));const J=z.filter((t,i,o)=>i===o.findIndex(a=>a.id===t.id));K(J);try{localStorage.setItem(F,JSON.stringify(J)),localStorage.setItem(R,Date.now().toString())}catch(t){console.log("Cache write failed:",t)}const Q=Date.now()-c;ie(Q),console.log(`🚀 Data loaded in ${Q}ms`)}catch(r){console.error("Ultra-fast fetch failed:",r),O("Failed to load students. Please try again.")}finally{S(!1),N(!1)}},[]);d.useEffect(()=>{const s=q();s?(K(s),S(!1),N(!0)):S(!0)},[q]),d.useEffect(()=>{let s;return(async()=>{s=fe(Z,async r=>{if(!r){O("No user is logged in."),S(!1),N(!1);return}g.length>0?y(r):await y(r)})})(),()=>{s&&s()}},[y,g.length]);const k=d.useMemo(()=>{let s=g;if(b){const c=new Set(A[b]||[]);s=s.filter(r=>c.has(r.id))}if(I.trim()){const c=new Set(A[I.trim()]||[]);s=s.filter(r=>c.has(r.id))}if(p){const c=p.toLowerCase();s=s.filter(r=>(r.name||"").toLowerCase().includes(c)||(r.email||"").toLowerCase().includes(c)||(r.rollNo||"").toLowerCase().includes(c))}return s.sort((c,r)=>E==="name"?(c.name||"").localeCompare(r.name||""):0)},[g,p,E,b,I,A]),V=d.useCallback(async()=>{N(!0),$.current=!1;try{localStorage.removeItem(F),localStorage.removeItem(R)}catch(c){console.log("Cache clear failed:",c)}const s=Z.currentUser;s&&await y(s)},[y]);return L&&g.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-12 animate-fade-in",children:[e.jsx("div",{className:"h-16 bg-gray-200 rounded-2xl mb-6 animate-pulse"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded-xl w-1/3 animate-pulse"})]}),e.jsx("div",{className:"grid gap-8 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:Array.from({length:9}).map((s,c)=>e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8 animate-fade-in border border-gray-100",style:{animationDelay:`${c*50}ms`},children:[e.jsxs("div",{className:"flex items-center mb-6",children:[e.jsx("div",{className:"w-20 h-20 bg-gray-200 rounded-full mr-6 animate-pulse"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-3/4 mb-3 animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2 animate-pulse"})]})]}),e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3 animate-pulse"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2 animate-pulse"})]}),e.jsxs("div",{className:"flex gap-3 mb-6",children:[e.jsx("div",{className:"h-8 w-20 bg-gray-200 rounded-full animate-pulse"}),e.jsx("div",{className:"h-8 w-24 bg-gray-200 rounded-full animate-pulse"})]}),e.jsx("div",{className:"h-6 w-24 bg-gray-200 rounded animate-pulse"})]},c))})]})}):M&&g.length===0?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center p-8",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100",children:[e.jsx(m,{icon:he,className:"text-blue-600 text-6xl mb-6 animate-bounce"}),e.jsx("div",{className:"text-gray-800 text-xl font-semibold mb-6",children:M}),e.jsxs("button",{onClick:V,className:"btn-campus-primary inline-flex items-center gap-3 px-8 py-4 rounded-xl shadow-lg transition-all duration-300 text-lg font-medium",children:[e.jsx(m,{icon:T}),"Try Again"]})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Students"}),e.jsx("span",{className:"text-xs text-gray-500",children:U>0?`Loaded in ${U}ms`:"Loading..."}),_&&e.jsxs("span",{className:"flex items-center gap-1 text-xs text-blue-600",children:[e.jsx(m,{icon:T,className:"animate-spin"}),"Refreshing"]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-xl font-semibold text-gray-900",children:k.length}),e.jsx("div",{className:"text-xs text-gray-500",children:"Total Students"})]}),e.jsxs("button",{onClick:V,disabled:_,className:"btn-campus-primary inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm disabled:opacity-50",children:[e.jsx(m,{icon:T,className:_?"animate-spin":""}),"Refresh"]})]})]}),e.jsx("div",{className:"compact-card mb-6",children:e.jsxs("div",{className:"grid gap-3 md:grid-cols-4",children:[e.jsx("div",{className:"md:col-span-2",children:e.jsxs("div",{className:"relative",children:[e.jsx(m,{icon:ge,className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"}),e.jsx("input",{type:"text",placeholder:"Search students by name, email, or roll number...",value:p,onChange:s=>ee(s.target.value),className:"w-full pl-10 pr-3 py-2 rounded-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-gray-50"})]})}),e.jsx("div",{children:e.jsxs("select",{value:E,onChange:s=>se(s.target.value),className:"w-full px-3 py-2 rounded-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-gray-50",children:[e.jsx("option",{value:"name",children:"Sort by Name"}),e.jsx("option",{value:"rollNo",children:"Sort by Roll No"})]})}),e.jsx("div",{children:e.jsxs("select",{value:b,onChange:s=>re(s.target.value),className:"w-full px-3 py-2 rounded-md border border-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-sm bg-gray-50",children:[e.jsx("option",{value:"",children:"All Courses"}),te.map(s=>e.jsxs("option",{value:s.id,children:[s.name," (",s.year,"-",s.section,")"]},s.id))]})})]})}),e.jsx("section",{className:"grid gap-4 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:k.map((s,c)=>e.jsxs("div",{className:"group bg-white rounded-lg border p-4 hover:shadow-sm animate-fade-in cursor-pointer transition-all",style:{animationDelay:`${c*50}ms`},onClick:()=>G(`/students/${s.year||"II"}/${s.section||"A"}/${s.id}`),children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mr-3",children:e.jsx(m,{icon:ye,className:"text-sm"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 truncate",children:s.name||"Unknown"}),e.jsx("p",{className:"text-xs text-gray-600",children:s.rollNo||"N/A"})]}),e.jsx("div",{className:"w-2.5 h-2.5 bg-green-500 rounded-full"})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(m,{icon:pe,className:"text-blue-600 text-sm"}),e.jsx("span",{className:"truncate",children:s.email||"No email"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(m,{icon:Se,className:"text-blue-600 text-sm"}),e.jsx("span",{children:s.rollNo||"No Roll No"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-600",children:[e.jsx(m,{icon:be,className:"text-blue-600 text-sm"}),e.jsxs("span",{children:[s.year||"N/A","-",s.section||"N/A"]})]})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("span",{className:"status-active inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",children:[e.jsx(m,{icon:Ne,className:"mr-1"}),"Active"]}),e.jsxs("span",{className:"status-completed inline-flex items-center px-2 py-1 rounded-full text-xs font-medium",children:[s.year||"N/A","-",s.section||"N/A"]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{type:"button",onClick:r=>{r.stopPropagation(),G(`/students/${s.year||"II"}/${s.section||"A"}/${s.id}`)},className:"inline-flex items-center gap-1.5 text-blue-600 hover:text-blue-700 font-medium transition-all text-sm",children:["View Details",e.jsx(m,{icon:je,className:"transition-transform group-hover:translate-x-1"})]})})]},s.id))}),k.length===0&&!L&&e.jsx("div",{className:"text-center py-16",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-12 border border-gray-100",children:[e.jsx(m,{icon:Ce,className:"text-gray-400 text-6xl mb-6"}),e.jsx("h3",{className:"text-2xl font-semibold text-gray-700 mb-3",children:"No students found"}),e.jsx("p",{className:"text-gray-600 text-lg",children:"Try adjusting your search or filter criteria."})]})})]})})};export{ke as default};
//# sourceMappingURL=StudentList-CfJjoNe6.js.map
