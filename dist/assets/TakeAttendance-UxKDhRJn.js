import{j as e}from"./query-_HUGc1jU.js";import{u as W,h as X,g as Y,r as d}from"./router-CGnu6c2M.js";import{d as x,a as T}from"./index-DokKvUxf.js";import{v as Z,n as z,o as ee,k as G,m as D,q as P,w as F,l as te,h as E,j as R}from"./firebase-BUGgE2xq.js";import{F as C,z as se,d as ae,r as ne,p as re,B as le}from"./ui-CbbphKl4.js";import"./vendor-Dazix4UH.js";const be=()=>{const q=W(),{state:V}=X(),{year:ce,section:ie,semester:oe,courseId:y}=Y(),[a,O]=d.useState(V?.course||null),[$,_]=d.useState([]),[m,A]=d.useState({}),[L,U]=d.useState(!1),[B,de]=d.useState(()=>new Date),[H,g]=d.useState(!0),[M,j]=d.useState(null),[f,J]=d.useState([]),[I,K]=d.useState({});d.useEffect(()=>{let t;return(async()=>{g(!0),j(null);try{await new Promise(s=>{t=ee(T,async r=>{if(!r){j("Not authenticated"),g(!1),s();return}try{if(!a&&y){const l=G(x,"courseDetails");(await D(P(l,F(te(),"in",[y])))).forEach(c=>{const o=c.ref.path.split("/");O({id:c.id,year:o[1],section:o[2],semester:o[3],...c.data()})})}if(!a&&!y){let l=[];try{const i=G(x,"courseDetails");l=(await D(P(i,F("instructor","==",r.uid)))).docs.map(o=>{const u=o.ref.path.split("/");return{id:o.id,year:u[1],section:u[2],semester:u[3],...o.data()}})}catch{const c=["I","II","III","IV"],o=["A","B","C","D","E","F"],u=["sem1","sem2"],h=[];c.forEach(p=>{o.forEach(v=>{u.forEach(w=>{h.push(D(P(z(x,"courses",p,v,w,"courseDetails"),F("instructor","==",r.uid))))})})}),(await Promise.all(h)).forEach(p=>{p.forEach(v=>{const w=v.ref.path.split("/");l.push({id:v.id,year:w[1],section:w[2],semester:w[3],...v.data()})})})}J(l)}}catch{}g(!1),s()})})}catch{j("Failed to initialize"),g(!1)}})(),()=>t&&t()},[a,y]),d.useEffect(()=>{(async()=>{if(!f||f.length===0)return;const n={};for(const s of f){const r=Array.isArray(s.students)?s.students:[],l=[];let i=r.length;for(let c=0;c<Math.min(r.length,5);c++){const o=r[c],u=[E(x,`students/${s.year}/${s.section}/${o}`),E(x,`students/${o}`)];let h=null;for(const N of u){const p=await R(N);if(p.exists()){h=p;break}}if(h&&h.exists()){const N=h.data();l.push({name:N.name||o,rollNo:N.rollNo||""})}}n[s.id]={count:i,items:l}}K(n)})()},[f]),d.useEffect(()=>{(async()=>{if(a){g(!0);try{let n=Array.isArray(a.students)?a.students:[];n.length===0&&(n=[]);const s=[];if(n.length>0)for(const l of n){const i=[E(x,`students/${a.year}/${a.section}/${l}`),E(x,`students/${l}`)];let c=null;for(const o of i){const u=await R(o);if(u.exists()){c=u;break}}c&&c.exists()&&s.push({id:c.id,...c.data(),year:a.year,section:a.section})}_(s);const r={};s.forEach(l=>{r[l.id]={present:!1,late:!1,excused:!1,absent:!0,note:""}}),A(r)}catch{j("Failed to load students")}finally{g(!1)}}})()},[a]);const S=(t,n)=>{A(s=>({...s,[t]:{...s[t],present:n==="present",late:n==="late",excused:n==="excused",absent:n==="absent"}}))},k=t=>{A(n=>{const s={...n};return Object.keys(s).forEach(r=>{s[r]={...s[r],present:t==="present",late:t==="late",excused:t==="excused",absent:t==="absent"}}),s})},b=d.useMemo(()=>{const t=Object.values(m),n=t.filter(i=>i.present).length,s=t.filter(i=>i.late).length,r=t.filter(i=>i.excused).length,l=t.filter(i=>i.absent).length;return{total:$.length,present:n,late:s,excused:r,absent:l}},[m,$.length]),Q=d.useCallback(async()=>{if(a){U(!0);try{await Z(z(x,"attendance"),{courseId:a.id,courseName:a.courseName||a.id,date:B.toISOString(),facultyId:T.currentUser?.uid||"",attendance:m,totalStudents:b.total,presentCount:b.present,lateCount:b.late,excusedCount:b.excused,absentCount:b.absent,createdAt:new Date().toISOString()}),q(-1)}catch{j("Failed to save attendance")}finally{U(!1)}}},[a,B,m,b,q]);return H?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 p-8",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:e.jsxs("div",{className:"mb-12 animate-fade-in",children:[e.jsx("div",{className:"h-16 bg-gray-200 rounded-2xl mb-6 animate-pulse"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded-xl w-1/3 animate-pulse"})]})})}):M?e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 flex items-center justify-center p-8",children:e.jsx("div",{className:"bg-white rounded-2xl shadow-xl p-12 text-center border border-gray-100",children:e.jsx("div",{className:"text-blue-600 text-xl font-semibold",children:M})})}):e.jsx("div",{className:"min-h-screen bg-gray-50 p-6",children:e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"mb-6 flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Take Attendance"}),e.jsx("p",{className:"text-xs text-gray-500",children:a?`${a?.courseName||y} • ${a?.year}-${a?.section} • ${a?.semester?.toUpperCase?.()||a?.semester}`:"Select a course to begin"})]}),!a&&(f.length===0?e.jsx("div",{className:"text-center text-gray-700 bg-white rounded-2xl shadow-xl p-12 border border-gray-100",children:"No courses found for your account."}):e.jsx("section",{className:"grid gap-4 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3",children:f.map((t,n)=>e.jsxs("div",{className:"group bg-white rounded-lg border p-4 hover:shadow-sm animate-fade-in",style:{animationDelay:`${n*100}ms`},children:[e.jsx("div",{className:"flex items-start justify-between mb-3",children:e.jsx("div",{className:"w-10 h-10 bg-blue-50 text-blue-600 rounded-md flex items-center justify-center",children:e.jsx(C,{icon:se,className:"text-sm"})})}),e.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-1",children:t.courseName||t.id}),e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:[t.year,"-",t.section," • ",t.semester?.toUpperCase?.()||t.semester]}),e.jsxs("div",{className:"text-xs text-gray-600 mb-3",children:["Enrolled Students: ",I[t.id]?.count??0,I[t.id]?.items?.length>0&&e.jsx("ul",{className:"mt-2 space-y-1",children:I[t.id].items.map((s,r)=>e.jsxs("li",{className:"text-gray-700",children:["• ",s.name,s.rollNo?` (${s.rollNo})`:""]},r))})]}),e.jsx("button",{onClick:()=>O(t),className:"btn-campus-primary px-3 py-2 rounded-md text-sm",children:"Start"})]},t.id))})),a&&e.jsxs("section",{className:"compact-card",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mb-6",children:[e.jsx("span",{className:"text-xs text-gray-600",children:"Mark all as:"}),e.jsx("button",{onClick:()=>k("present"),className:"px-2.5 py-1 rounded-full bg-green-100 text-green-700 text-xs font-medium hover:bg-green-200",children:"Present"}),e.jsx("button",{onClick:()=>k("late"),className:"px-2.5 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-medium hover:bg-yellow-200",children:"Late"}),e.jsx("button",{onClick:()=>k("excused"),className:"px-2.5 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium hover:bg-blue-200",children:"Excused"}),e.jsx("button",{onClick:()=>k("absent"),className:"px-2.5 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium hover:bg-red-200",children:"Absent"})]}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:$.map(t=>e.jsx("div",{className:"bg-gray-50 border border-gray-200 rounded-md p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-blue-50 text-blue-600 rounded-md flex items-center justify-center",children:e.jsx(C,{icon:ae,className:"text-xs"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold text-gray-900",children:t.name||t.id}),e.jsx("div",{className:"text-xs text-gray-600",children:t.rollNo||t.email})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>S(t.id,"present"),className:`px-2.5 py-1 rounded-full text-xs font-medium ${m[t.id]?.present?"bg-green-500 text-white":"bg-gray-100 text-gray-600 hover:bg-green-100"}`,children:[e.jsx(C,{icon:ne,className:"mr-1"}),"Present"]}),e.jsxs("button",{onClick:()=>S(t.id,"late"),className:`px-2.5 py-1 rounded-full text-xs font-medium ${m[t.id]?.late?"bg-yellow-500 text-white":"bg-gray-100 text-gray-600 hover:bg-yellow-100"}`,children:[e.jsx(C,{icon:re,className:"mr-1"}),"Late"]}),e.jsx("button",{onClick:()=>S(t.id,"excused"),className:`px-2.5 py-1 rounded-full text-xs font-medium ${m[t.id]?.excused?"bg-blue-500 text-white":"bg-gray-100 text-gray-600 hover:bg-blue-100"}`,children:"Excused"}),e.jsxs("button",{onClick:()=>S(t.id,"absent"),className:`px-2.5 py-1 rounded-full text-xs font-medium ${m[t.id]?.absent?"bg-red-500 text-white":"bg-gray-100 text-gray-600 hover:bg-red-100"}`,children:[e.jsx(C,{icon:le,className:"mr-1"}),"Absent"]})]})]})},t.id))}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:Q,disabled:L,className:"btn-campus-primary px-4 py-2 rounded-md text-sm disabled:opacity-50",children:L?"Saving...":"Save Attendance"})})]})]})})};export{be as default};
//# sourceMappingURL=TakeAttendance-UxKDhRJn.js.map
